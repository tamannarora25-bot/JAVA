// CombinedServletApp.java
// Demonstrates: User Login, Employee Directory, and Student Attendance Portal
// Using Servlets, JSP (simulated), and JDBC (MySQL)

package com.example.web;

import javax.servlet.*;
import javax.servlet.http.*;
import java.io.*;
import java.sql.*;

// ✅ Database Utility (Connection)
class DBUtil {
    private static final String URL = "jdbc:mysql://localhost:3306/web_demo?useSSL=false&serverTimezone=UTC";
    private static final String USER = "root";
    private static final String PASS = "password"; // Change to your MySQL password

    public static Connection getConnection() throws Exception {
        Class.forName("com.mysql.cj.jdbc.Driver");
        return DriverManager.getConnection(URL, USER, PASS);
    }
}

// ✅ Combined Servlet for all functionalities
public class CombinedServletApp extends HttpServlet {

    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        String action = request.getParameter("action");
        if (action == null) action = "home";

        response.setContentType("text/html");
        PrintWriter out = response.getWriter();

        out.println("<html><head><title>Web Portal</title></head><body>");
        out.println("<h2>Java Web Application Portal</h2>");
        out.println("<a href='?action=login'>Login</a> | ");
        out.println("<a href='?action=employees'>View Employees</a> | ");
        out.println("<a href='?action=attendance'>Add Attendance</a><hr>");

        switch (action) {
            case "login":
                showLoginForm(out);
                break;
            case "loginSubmit":
                handleLogin(request, out);
                break;
            case "employees":
                showEmployees(request, out);
                break;
            case "attendance":
                showAttendanceForm(out);
                break;
            case "attendanceSubmit":
                handleAttendance(request, out);
                break;
            default:
                out.println("<h3>Welcome to the Web Portal!</h3>");
        }

        out.println("</body></html>");
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        doGet(request, response);
    }

    // ---------- LOGIN PART ----------
    private void showLoginForm(PrintWriter out) {
        out.println("<h3>Login Form</h3>");
        out.println("<form method='get'>");
        out.println("<input type='hidden' name='action' value='loginSubmit'>");
        out.println("Username: <input type='text' name='username'><br><br>");
        out.println("Password: <input type='password' name='password'><br><br>");
        out.println("<input type='submit' value='Login'>");
        out.println("</form>");
    }

    private void handleLogin(HttpServletRequest request, PrintWriter out) {
        String uname = request.getParameter("username");
        String pass = request.getParameter("password");
        try (Connection conn = DBUtil.getConnection()) {
            PreparedStatement ps = conn.prepareStatement("SELECT * FROM users WHERE username=? AND password=?");
            ps.setString(1, uname);
            ps.setString(2, pass);
            ResultSet rs = ps.executeQuery();
            if (rs.next()) {
                out.println("<h3>Welcome, " + uname + "!</h3>");
            } else {
                out.println("<h3>Invalid credentials. Try again.</h3>");
                showLoginForm(out);
            }
        } catch (Exception e) {
            out.println("<p>Error: " + e.getMessage() + "</p>");
        }
    }

    // ---------- EMPLOYEE PART ----------
    private void showEmployees(HttpServletRequest request, PrintWriter out) {
        String idParam = request.getParameter("id");
        out.println("<h3>Employee Directory</h3>");
        out.println("<form method='get'>");
        out.println("<input type='hidden' name='action' value='employees'>");
        out.println("Search by ID: <input type='text' name='id'>");
        out.println("<input type='submit' value='Search'>");
        out.println("</form><br>");

        try (Connection conn = DBUtil.getConnection()) {
            PreparedStatement ps;
            if (idParam != null && !idParam.isEmpty()) {
                ps = conn.prepareStatement("SELECT * FROM employees WHERE id=?");
                ps.setInt(1, Integer.parseInt(idParam));
            } else {
                ps = conn.prepareStatement("SELECT * FROM employees");
            }
            ResultSet rs = ps.executeQuery();
            out.println("<table border='1'><tr><th>ID</th><th>Name</th><th>Designation</th></tr>");
            while (rs.next()) {
                out.println("<tr><td>" + rs.getInt("id") + "</td><td>" +
                        rs.getString("name") + "</td><td>" +
                        rs.getString("designation") + "</td></tr>");
            }
            out.println("</table>");
        } catch (Exception e) {
            out.println("<p>Error: " + e.getMessage() + "</p>");
        }
    }

    // ---------- ATTENDANCE PART ----------
    private void showAttendanceForm(PrintWriter out) {
        out.println("<h3>Student Attendance Form</h3>");
        out.println("<form method='get'>");
        out.println("<input type='hidden' name='action' value='attendanceSubmit'>");
        out.println("Student Name: <input type='text' name='name'><br><br>");
        out.println("Date: <input type='date' name='date'><br><br>");
        out.println("Status: <select name='status'><option>Present</option><option>Absent</option></select><br><br>");
        out.println("<input type='submit' value='Submit'>");
        out.println("</form>");
    }

    private void handleAttendance(HttpServletRequest request, PrintWriter out) {
        String name = request.getParameter("name");
        String date = request.getParameter("date");
        String status = request.getParameter("status");

        try (Connection conn = DBUtil.getConnection()) {
            PreparedStatement ps = conn.prepareStatement(
                    "INSERT INTO attendance(student_name, attendance_date, status) VALUES (?, ?, ?)");
            ps.setString(1, name);
            ps.setString(2, date);
            ps.setString(3, status);
            ps.executeUpdate();
            out.println("<h3>Attendance saved successfully for " + name + "!</h3>");
        } catch (Exception e) {
            out.println("<p>Error: " + e.getMessage() + "</p>");
        }
    }
}
